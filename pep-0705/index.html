
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 705 – TypedMapping: Type Hints for Mappings with a Fixed Set of Keys | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0705/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta name="description" content="Python Enhancement Proposals (PEPs)">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 705</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 705 – TypedMapping: Type Hints for Mappings with a Fixed Set of Keys</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Alice Purcell &lt;alicederyn&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Sponsor<span class="colon">:</span></dt>
<dd class="field-even">Pablo Galindo &lt;pablogsal&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-odd">Discussions-To<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/pep-705-typedmapping/24827">Discourse thread</a></dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Topic<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="../topic/typing/">Typing</a></dd>
<dt class="field-odd">Created<span class="colon">:</span></dt>
<dd class="field-odd">07-Nov-2022</dd>
<dt class="field-even">Python-Version<span class="colon">:</span></dt>
<dd class="field-even">3.12</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://mail.python.org/archives/list/typing-sig&#64;python.org/thread/6FR6RKNUZU4UY6B6RXC2H4IAHKBU3UKV/" title="Typing-SIG thread">30-Sep-2022</a>,
<a class="reference external" href="https://mail.python.org/archives/list/python-dev&#64;python.org/thread/2P26R4VH2ZCNNNOQCBZWEM4RNF35OXOW/" title="Python-Dev thread">02-Nov-2022</a>,
<a class="reference external" href="https://discuss.python.org/t/pep-705-typedmapping/24827" title="Discourse thread">14-Mar-2023</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#multiple-inheritance-and-typeddict">Multiple inheritance and TypedDict</a></li>
<li><a class="reference internal" href="#multiple-inheritance-and-protocol">Multiple inheritance and Protocol</a></li>
<li><a class="reference internal" href="#type-consistency-rules">Type consistency rules</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-alternatives">Rejected Alternatives</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p><a class="pep reference internal" href="../pep-0589/" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys">PEP 589</a> defines the structural type <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.TypedDict" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypedDict</span></code></a> for dictionaries with a fixed set of keys.
As <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> is a mutable type, it is difficult to correctly annotate methods which accept read-only parameters in a way that doesn’t prevent valid inputs.
This PEP proposes a type constructor <code class="docutils literal notranslate"><span class="pre">typing.TypedMapping</span></code> to support this use case.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>Representing structured data using (potentially nested) dictionaries with string keys is a common pattern in Python programs. <a class="pep reference internal" href="../pep-0589/" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys">PEP 589</a> allows these values to be type checked when the exact type is known up-front, but it is hard to write read-only code that accepts more specific variants: for instance, where fields may be subtypes or restrict a union of possible types. This is an especially common issue when writing APIs for services, which may support a wide range of input structures, and typically do not need to modify their input.</p>
<p>For illustration, we will try to add type hints to a function <code class="docutils literal notranslate"><span class="pre">movie_string</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">movie_string</span><span class="p">(</span><span class="n">movie</span><span class="p">:</span> <span class="n">Movie</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">movie</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">movie</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">movie</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">movie</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
</pre></div>
</div>
<p>We could define this <code class="docutils literal notranslate"><span class="pre">Movie</span></code> type using a <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NotRequired</span><span class="p">,</span> <span class="n">TypedDict</span>

<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
</pre></div>
</div>
<p>But suppose we have another type where year is required:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MovieRecord</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span>
</pre></div>
</div>
<p>Attempting to pass a <code class="docutils literal notranslate"><span class="pre">MovieRecord</span></code> into <code class="docutils literal notranslate"><span class="pre">movie_string</span></code> results in the error (using mypy):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Argument 1 to &quot;movie_string&quot; has incompatible type &quot;MovieRecord&quot;; expected &quot;Movie&quot;
</pre></div>
</div>
<p>This particular use case should be type-safe, but the type checker correctly stops the
user from passing a <code class="docutils literal notranslate"><span class="pre">MovieRecord</span></code> into a <code class="docutils literal notranslate"><span class="pre">Movie</span></code> parameter in the general case, because
the <code class="docutils literal notranslate"><span class="pre">Movie</span></code> class has mutator methods that could potentially allow the function to break
the type constraints in <code class="docutils literal notranslate"><span class="pre">MovieRecord</span></code> (e.g. with <code class="docutils literal notranslate"><span class="pre">movie[&quot;year&quot;]</span> <span class="pre">=</span> <span class="pre">None</span></code> or <code class="docutils literal notranslate"><span class="pre">del</span> <span class="pre">movie[&quot;year&quot;]</span></code>).
The problem disappears if we don’t have mutator methods in <code class="docutils literal notranslate"><span class="pre">Movie</span></code>. This could be achieved by defining an immutable interface using a <a class="pep reference internal" href="../pep-0544/" title="PEP 544 – Protocols: Structural subtyping (static duck typing)">PEP 544</a> <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Protocol" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Protocol</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">overload</span>

<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p>This is very repetitive, easy to get wrong, and is still missing important method definitions like <code class="docutils literal notranslate"><span class="pre">__contains__()</span></code> and <code class="docutils literal notranslate"><span class="pre">keys()</span></code>.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>The proposed <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> type allows a straightforward way of defining these types that should be familiar to existing users of <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> and support the cases exemplified above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NotRequired</span><span class="p">,</span> <span class="n">TypedMapping</span>

<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">TypedMapping</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
</pre></div>
</div>
<p>In addition to those benefits, by flagging arguments of a function as <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code>, it makes explicit not just to typecheckers but also to users that the function is not going to modify its inputs, which is usually a desirable property of a function interface.
Finally, this allows bringing the benefits of <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> to other mapping types that are unrelated to <code class="docutils literal notranslate"><span class="pre">dict</span></code>.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> type defines a protocol with the same methods as <a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapping</span></code></a>, but with value types determined per-key as with <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>.</p>
<p>Notable similarities to <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>:</p>
<ul class="simple">
<li>A <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> protocol can be declared using class-based or alternative syntax.</li>
<li>Keys must be strings.</li>
<li>By default, all specified keys must be present in a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> instance. It is possible to override this by specifying totality, or by using <code class="docutils literal notranslate"><span class="pre">NotRequired</span></code> from <a class="pep reference internal" href="../pep-0655/" title="PEP 655 – Marking individual TypedDict items as required or potentially-missing">PEP 655</a>.</li>
<li>Methods are not allowed in the declaration (though they may be inherited).</li>
</ul>
<p>Notable differences from <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>:</p>
<ul class="simple">
<li>The runtime type of a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> object is not constrained to be a <code class="docutils literal notranslate"><span class="pre">dict</span></code>.</li>
<li>No mutator methods (<code class="docutils literal notranslate"><span class="pre">__setitem__</span></code>, <code class="docutils literal notranslate"><span class="pre">__delitem__</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, etc.) will be generated.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">|</span></code> operator is not supported.</li>
<li>A class definition defines a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> protocol if and only if <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> appears directly in its class bases.</li>
<li>Subclasses can narrow value types, in the same manner as other protocols.</li>
</ul>
<p>As with <a class="pep reference internal" href="../pep-0589/" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys">PEP 589</a>, this PEP provides a sketch of how a type checker is expected to support type checking operations involving <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> and <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> objects, but details are left to implementors. In particular, type compatibility should be based on structural compatibility.</p>
<section id="multiple-inheritance-and-typeddict">
<h3><a class="toc-backref" href="#multiple-inheritance-and-typeddict" role="doc-backlink">Multiple inheritance and TypedDict</a></h3>
<p>A type that inherits from a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> protocol and from <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> (either directly or indirectly):</p>
<ul class="simple">
<li>is the structural intersection of its parents, or invalid if no such intersection exists</li>
<li>instances must be a dict subclass</li>
<li>adds mutator methods only for fields it explicitly (re)declares</li>
</ul>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">TypedMapping</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">MovieRecord</span><span class="p">(</span><span class="n">Movie</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span>

<span class="n">movie</span><span class="p">:</span> <span class="n">MovieRecord</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Blade Runner&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1982</span> <span class="p">}</span>

<span class="n">movie</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1985</span>  <span class="c1"># Fine; mutator methods added in definition</span>
<span class="n">movie</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Terminator&quot;</span>  <span class="c1"># Type check error; &quot;name&quot; mutator not declared</span>
</pre></div>
</div>
<p>Inheriting, directly or indirectly, from both <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> and <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> will continue to fail at runtime, and should continue to be rejected by type checkers.</p>
</section>
<section id="multiple-inheritance-and-protocol">
<h3><a class="toc-backref" href="#multiple-inheritance-and-protocol" role="doc-backlink">Multiple inheritance and Protocol</a></h3>
<ul>
<li>A type that inherits from a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> protocol and from a <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> protocol must satisfy the protocols defined by both, but is not itself a protocol unless it inherits directly from <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> or <code class="docutils literal notranslate"><span class="pre">Protocol</span></code>.</li>
<li>A type that inherits from a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> protocol and from <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> itself is configured as a <code class="docutils literal notranslate"><span class="pre">Protocol</span></code>. Methods and properties may be defined; keys may not:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Movie</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">):</span>
    <span class="c1"># Declare a mutable property called &#39;year&#39;</span>
    <span class="c1"># This does not affect the dictionary key &#39;year&#39;</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">str</span>
</pre></div>
</div>
</li>
<li>A type that inherits from a <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> protocol and from <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> itself is configured as a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code>. Keys may be defined; methods and properties may not:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">TypedMapping</span><span class="p">):</span>
    <span class="c1"># Declare a key &#39;year&#39;</span>
    <span class="c1"># This does not affect the property &#39;year&#39;</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="type-consistency-rules">
<h3><a class="toc-backref" href="#type-consistency-rules" role="doc-backlink">Type consistency rules</a></h3>
<p>Informally speaking, <em>type consistency</em> is a generalization of the is-subtype-of relation to support the <code class="docutils literal notranslate"><span class="pre">Any</span></code> type. It is defined more formally in <a class="pep reference internal" href="../pep-0483/" title="PEP 483 – The Theory of Type Hints">PEP 483</a>. This section introduces the new, non-trivial rules needed to support type consistency for <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> types.</p>
<p>First, any <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> type is consistent with <code class="docutils literal notranslate"><span class="pre">Mapping[str,</span> <span class="pre">object]</span></code>.
Second, a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> or <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> type <code class="docutils literal notranslate"><span class="pre">A</span></code> is consistent with <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> <code class="docutils literal notranslate"><span class="pre">B</span></code> if <code class="docutils literal notranslate"><span class="pre">A</span></code> is structurally compatible with <code class="docutils literal notranslate"><span class="pre">B</span></code>. This is true if and only if both of these conditions are satisfied:</p>
<ul class="simple">
<li>For each key in <code class="docutils literal notranslate"><span class="pre">A</span></code>, <code class="docutils literal notranslate"><span class="pre">B</span></code> has the corresponding key and the corresponding value type in <code class="docutils literal notranslate"><span class="pre">B</span></code> is consistent with the value type in <code class="docutils literal notranslate"><span class="pre">A</span></code>.</li>
<li>For each required key in <code class="docutils literal notranslate"><span class="pre">A</span></code>, the corresponding key is required in <code class="docutils literal notranslate"><span class="pre">B</span></code>.</li>
</ul>
<p>Discussion:</p>
<ul>
<li>Value types behave covariantly, since <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> objects have no mutator methods. This is similar to container types such as <code class="docutils literal notranslate"><span class="pre">Mapping</span></code>, and different from relationships between two <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> types. Example:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">TypedMapping</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">b</span><span class="p">:</span> <span class="n">B</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># Accepted by type checker</span>
</pre></div>
</div>
</li>
<li>A <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> or <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> type with a required key is consistent with a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> type where the same key is a non-required key, again unlike relationships between two <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> types. Example:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">TypedMapping</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="n">b</span><span class="p">:</span> <span class="n">B</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># Accepted by type checker</span>
</pre></div>
</div>
</li>
<li>A <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> type <code class="docutils literal notranslate"><span class="pre">A</span></code> with no key <code class="docutils literal notranslate"><span class="pre">'x'</span></code> is not consistent with a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> type with a non-required key <code class="docutils literal notranslate"><span class="pre">'x'</span></code>, since at runtime the key <code class="docutils literal notranslate"><span class="pre">'x'</span></code> could be present and have an incompatible type (which may not be visible through <code class="docutils literal notranslate"><span class="pre">A</span></code> due to structural subtyping). This is the same as for <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> types. Example:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">TypedMapping</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">TypedMapping</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">TypedMapping</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># Type check error: &#39;B&#39; incompatible with &#39;A&#39;</span>

<span class="n">c</span><span class="p">:</span> <span class="n">C</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>
<span class="n">g</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>  <span class="c1"># Runtime error: str + int</span>
</pre></div>
</div>
</li>
<li>A <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> with all <code class="docutils literal notranslate"><span class="pre">int</span></code> values is not consistent with <code class="docutils literal notranslate"><span class="pre">Mapping[str,</span> <span class="pre">int]</span></code>, since there may be additional non-<code class="docutils literal notranslate"><span class="pre">int</span></code> values not visible through the type, due to structural subtyping. This mirrors <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>. Example:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">TypedMapping</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">TypedMapping</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">sum_values</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sum_values</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># Type check error: &#39;A&#39; incompatible with Mapping[str, int]</span>

<span class="n">b</span><span class="p">:</span> <span class="n">B</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>
<span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># Runtime error: int + str</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>This PEP changes the rules for how <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> behaves (allowing subclasses to
inherit from <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> protocols in a way that changes the resulting
overloads), so code that inspects <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> types will have to change. This
is expected to mainly affect type-checkers.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> type will be added to the <code class="docutils literal notranslate"><span class="pre">typing_extensions</span></code> module,
enabling its use in older versions of Python.</p>
</section>
<section id="security-implications">
<h2><a class="toc-backref" href="#security-implications" role="doc-backlink">Security Implications</a></h2>
<p>There are no known security consequences arising from this PEP.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>Class documentation should be added to the <a class="reference external" href="https://docs.python.org/3/library/typing.html#module-typing" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">typing</span></code></a> module’s documentation, using
that for <a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapping</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Protocol" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Protocol</span></code></a> and
<a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.TypedDict" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypedDict</span></code></a> as examples. Suggested introductory sentence: “Base class
for read-only mapping protocol classes.”</p>
<p>This PEP could be added to the others listed in the <a class="reference external" href="https://docs.python.org/3/library/typing.html#module-typing" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">typing</span></code></a> module’s documentation.</p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p>No reference implementation exists yet.</p>
</section>
<section id="rejected-alternatives">
<h2><a class="toc-backref" href="#rejected-alternatives" role="doc-backlink">Rejected Alternatives</a></h2>
<p>Several variations were considered and discarded:</p>
<ul class="simple">
<li>A <code class="docutils literal notranslate"><span class="pre">readonly</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>, behaving much like <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> but with the additional constraint that instances must be dictionaries at runtime. This was discarded as less flexible due to the extra constraint; additionally, the new type nicely mirrors the existing <code class="docutils literal notranslate"><span class="pre">Mapping</span></code>/<code class="docutils literal notranslate"><span class="pre">Dict</span></code> types.</li>
<li>Inheriting from a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> subclass and <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> resulting in mutator methods being added for all fields, not just those actively (re)declared in the class body. Discarded as less flexible, and not matching how inheritance works in other cases for <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> (e.g. total=False and total=True do not affect fields not specified in the class body).</li>
<li>A generic type that removes mutator methods from its parameter, e.g. <code class="docutils literal notranslate"><span class="pre">Readonly[MovieRecord]</span></code>. This would naturally want to be defined for a wider set of types than just <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> subclasses, and also raises questions about whether and how it applies to nested types. We decided to keep the scope of this PEP narrower.</li>
<li>Declaring methods directly on a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> class. Methods are a kind of property, but declarations on a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> class are defining keys, so mixing the two is potentially confusing. Banning methods also makes it very easy to decide whether a <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> subclass can mix in a protocol or not (yes if it’s just <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> superclasses, no if there’s a <code class="docutils literal notranslate"><span class="pre">Protocol</span></code>).</li>
</ul>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0705.rst">https://github.com/python/peps/blob/main/peps/pep-0705.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/pep-0705.rst">2023-09-09 17:39:29 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#multiple-inheritance-and-typeddict">Multiple inheritance and TypedDict</a></li>
<li><a class="reference internal" href="#multiple-inheritance-and-protocol">Multiple inheritance and Protocol</a></li>
<li><a class="reference internal" href="#type-consistency-rules">Type consistency rules</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security Implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-alternatives">Rejected Alternatives</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0705.rst">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
</body>
</html>